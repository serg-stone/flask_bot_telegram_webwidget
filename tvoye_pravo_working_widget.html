<!-- –†–∞–±–æ—á–∏–π –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞ "–¢–≤–æ—ë –ø—Ä–∞–≤–æ" –¥–ª—è Tilda -->
<!-- –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ —á–∞—Ç–∞ -->
<style>
.legal-chat-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    height: 500px;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.1);
    display: none;
    flex-direction: column;
    z-index: 9999;
    font-family: 'Arial', sans-serif;
}

.legal-chat-widget.active {
    display: flex;
}

.legal-chat-header {
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.legal-chat-header h3 {
    margin: 0;
    font-size: 16px;
}

.legal-chat-subtitle {
    font-size: 12px;
    opacity: 0.8;
    margin: 2px 0 0 0;
}

.legal-mode-selection {
    padding: 20px;
    text-align: center;
    background: white;
}

.legal-mode-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 14px;
    cursor: pointer;
    margin: 5px;
    font-weight: 500;
    transition: transform 0.2s;
}

.legal-mode-btn:hover {
    transform: translateY(-2px);
}

.legal-chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #f5f5f5;
    display: none;
}

.legal-message {
    margin-bottom: 10px;
    max-width: 80%;
    padding: 10px;
    border-radius: 10px;
    word-wrap: break-word;
}

.legal-message.user {
    background: #E3E3E3;
    margin-left: auto;
}

.legal-message.bot {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.legal-chat-input {
    padding: 15px;
    border-top: 1px solid #eee;
    display: none;
    background: white;
    border-radius: 0 0 15px 15px;
}

.legal-chat-input input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 20px;
    margin-right: 10px;
    outline: none;
    width: calc(100% - 80px);
}

.legal-chat-input button {
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.3s;
}

.legal-chat-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    z-index: 9999;
    transition: transform 0.3s;
    color: white;
    font-weight: bold;
    font-size: 24px;
}

.legal-chat-button:hover {
    transform: scale(1.1);
}

.legal-typing-indicator {
    display: none;
    padding: 10px 15px;
    background: #f1f3f5;
    border-radius: 18px;
    align-self: flex-start;
    color: #666;
    font-style: italic;
    margin: 0 15px 10px 15px;
}

.legal-back-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    margin-right: 10px;
    padding: 5px;
    border-radius: 50%;
    display: none;
}

.legal-back-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

@media (max-width: 480px) {
    .legal-chat-widget {
        width: 100%;
        height: 100%;
        bottom: 0;
        right: 0;
        border-radius: 0;
    }
    
    .legal-chat-header {
        border-radius: 0;
    }
    
    .legal-chat-button {
        bottom: 10px;
        right: 10px;
    }
}
</style>

<!-- HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏–¥–∂–µ—Ç–∞ -->
<div class="legal-chat-button" onclick="toggleLegalChat()">
    üí¨
</div>

<div class="legal-chat-widget" id="legalChatWidget">
    <div class="legal-chat-header">
        <div style="display: flex; align-items: center;">
            <button class="legal-back-btn" id="legalBackBtn" onclick="goBackToModes()">‚Üê</button>
            <div>
                <h3>–¢–≤–æ—ë –ø—Ä–∞–≤–æ</h3>
                <div class="legal-chat-subtitle">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏ –æ–Ω–ª–∞–π–Ω</div>
            </div>
        </div>
        <span style="cursor: pointer;" onclick="toggleLegalChat()">‚úï</span>
    </div>
    
    <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ -->
    <div class="legal-mode-selection" id="legalModeSelection">
        <p style="margin-bottom: 20px; color: #666;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</p>
        <button class="legal-mode-btn" onclick="selectLegalMode('consultation')">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</button>
        <button class="legal-mode-btn" onclick="selectLegalMode('booking')">–ë—ã—Å—Ç—Ä–∞—è –∑–∞–ø–∏—Å—å</button>
    </div>
    
    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="legal-chat-messages" id="legalChatMessages">
        <div class="legal-message bot">
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏.
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è -->
    <div class="legal-typing-indicator" id="legalTypingIndicator">
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –≤–æ–ø—Ä–æ—Å...
    </div>
    
    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
    <div class="legal-chat-input" id="legalChatInput">
        <input type="text" id="legalMessageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleLegalKeyPress(event)">
        <button onclick="sendLegalMessage()">‚Üí</button>
    </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–∞—Ç–∞ -->
<script>
console.log('=== –¢–≤–æ—ë –ø—Ä–∞–≤–æ - –ß–∞—Ç –≤–∏–¥–∂–µ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É ===');

// –ù–ê–°–¢–†–û–ô–ö–ê: URL –≤–∞—à–µ–≥–æ Flask —Å–µ—Ä–≤–µ—Ä–∞
const LEGAL_API_URL = 'https://42c759928dec.ngrok-free.app/api/chat';

let legalIsOpen = false;
let legalCurrentMode = null;
let legalThreadId = null;

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const LEGAL_USER_ID = 'legal_user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

function toggleLegalChat() {
    console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞, isOpen:', legalIsOpen);
    const widget = document.getElementById('legalChatWidget');
    const toggle = document.querySelector('.legal-chat-button');
    
    legalIsOpen = !legalIsOpen;
    
    if (legalIsOpen) {
        widget.classList.add('active');
        toggle.style.display = 'none';
        console.log('–ß–∞—Ç –æ—Ç–∫—Ä—ã—Ç');
    } else {
        widget.classList.remove('active');
        toggle.style.display = 'flex';
        resetLegalChat();
        console.log('–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç');
    }
}

function resetLegalChat() {
    legalCurrentMode = null;
    legalThreadId = null;
    document.getElementById('legalModeSelection').style.display = 'block';
    document.getElementById('legalChatMessages').style.display = 'none';
    document.getElementById('legalChatInput').style.display = 'none';
    document.getElementById('legalBackBtn').style.display = 'none';
    document.getElementById('legalChatMessages').innerHTML = '';
}

function selectLegalMode(mode) {
    console.log('–í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º:', mode);
    legalCurrentMode = mode;
    
    document.getElementById('legalModeSelection').style.display = 'none';
    document.getElementById('legalChatMessages').style.display = 'block';
    document.getElementById('legalChatInput').style.display = 'block';
    document.getElementById('legalBackBtn').style.display = 'block';
    
    // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('legalChatMessages').innerHTML = '';
    
    if (mode === 'consultation') {
        addLegalMessage('–í—ã –≤ —Ä–µ–∂–∏–º–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å:', 'bot');
    } else if (mode === 'booking') {
        addLegalMessage('–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º –≤–∞—Å –∫ –∞–¥–≤–æ–∫–∞—Ç—É. –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?', 'bot');
    }
    
    document.getElementById('legalMessageInput').focus();
}

function goBackToModes() {
    console.log('–í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É —Ä–µ–∂–∏–º–∞');
    legalCurrentMode = null;
    legalThreadId = null;
    document.getElementById('legalModeSelection').style.display = 'block';
    document.getElementById('legalChatMessages').style.display = 'none';
    document.getElementById('legalChatInput').style.display = 'none';
    document.getElementById('legalBackBtn').style.display = 'none';
}

function handleLegalKeyPress(event) {
    if (event.key === 'Enter') {
        sendLegalMessage();
    }
}

async function sendLegalMessage() {
    const input = document.getElementById('legalMessageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addLegalMessage(message, 'user');
    input.value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
    showLegalTyping(true);
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
    const sendBtn = document.querySelector('.legal-chat-input button');
    sendBtn.disabled = true;
    
    try {
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ API:', LEGAL_API_URL);
        
        const response = await fetch(LEGAL_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify({
                message: message,
                thread_id: legalThreadId
            })
        });
        
        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API:', data);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        showLegalTyping(false);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
        if (data.response) {
            addLegalMessage(data.response, 'bot');
            if (data.thread_id) {
                legalThreadId = data.thread_id;
                console.log('–û–±–Ω–æ–≤–ª–µ–Ω thread_id:', legalThreadId);
            }
        } else if (data.error) {
            addLegalMessage('–û—à–∏–±–∫–∞: ' + data.error, 'bot');
        } else {
            addLegalMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'bot');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        showLegalTyping(false);
        addLegalMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.', 'bot');
    } finally {
        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        sendBtn.disabled = false;
    }
}

function addLegalMessage(text, sender) {
    const messagesContainer = document.getElementById('legalChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `legal-message ${sender}`;
    messageDiv.textContent = text;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showLegalTyping(show) {
    const indicator = document.getElementById('legalTypingIndicator');
    if (show) {
        indicator.style.display = 'block';
        document.getElementById('legalChatMessages').scrollTop = document.getElementById('legalChatMessages').scrollHeight;
    } else {
        indicator.style.display = 'none';
    }
}

// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    console.log('–¢–≤–æ—ë –ø—Ä–∞–≤–æ - –ß–∞—Ç –≤–∏–¥–∂–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
    console.log('Server URL:', LEGAL_API_URL);
    console.log('User ID:', LEGAL_USER_ID);
});

console.log('=== –¢–≤–æ—ë –ø—Ä–∞–≤–æ - –°–∫—Ä–∏–ø—Ç –≤–∏–¥–∂–µ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω ===');
</script>
